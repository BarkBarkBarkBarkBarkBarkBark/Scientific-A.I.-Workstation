a2ui_spec_version: "0.1"
kind: "PluginModule"
pluginId: "zlab.sorting_script"
title: "Zlab Sorting Script"
subtitle: "Upload → Sort → Analyze → Curate"

context:
  defaults:
    uiState:
      status:
        uploaded: false
        sorted: false
        analyzed: false
        curation: false

computed:
  artifactsRoot:
    op: concat
    args: ["saw-workspace/artifacts/", "${node.data.pluginId}"]
  dataRoot:
    op: concat
    args: ["${computed.artifactsRoot}", "/data"]
  patient:
    op: trim
    args: ["${node.data.params.patient}"]
  session:
    op: trim
    args: ["${node.data.params.session}"]
  recordingPath:
    op: trim
    args: ["${node.data.params.recording_path}"]
  rawSessionDir:
    op: concat
    args: ["${computed.dataRoot}", "/raw/", "${computed.patient}", "/", "${computed.session}"]
  sortedSessionDir:
    op: concat
    args: ["${computed.dataRoot}", "/sorted/", "${computed.patient}", "/", "${computed.session}"]
  sorterDir:
    op: concat
    args: ["${computed.sortedSessionDir}", "/sorter_folder"]
  analyzerDir:
    op: concat
    args: ["${computed.sortedSessionDir}", "/analyzer_folder"]
  curationDir:
    op: concat
    args: ["${computed.analyzerDir}", "/spikeinterface_gui"]
  canUpload:
    op: and
    args:
      - { op: gt, args: [{ op: len, args: ["${computed.patient}"] }, 0] }
      - { op: gt, args: [{ op: len, args: ["${computed.session}"] }, 0] }
      - { op: gt, args: [{ op: len, args: ["${computed.recordingPath}"] }, 0] }

queries:
  - id: probe.uploaded
    kind: fsTreeSearch
    input:
      root: "${computed.rawSessionDir}"
      depth: 3
      match:
        type: file
        nameEndsWith: ".rhd"
    output: { into: "uiState.status.uploaded" }

  - id: probe.sorted
    kind: fsDirNonEmpty
    input: { root: "${computed.sorterDir}", depth: 1 }
    output: { into: "uiState.status.sorted" }

  - id: probe.analyzed
    kind: fsDirNonEmpty
    input: { root: "${computed.analyzerDir}", depth: 1 }
    output: { into: "uiState.status.analyzed" }

  - id: probe.curation
    kind: fsFileExists
    input: { path: "${computed.curationDir}/curation_data.json" }
    output: { into: "uiState.status.curation" }

actions:
  - id: setParam
    kind: state.updateNodeParam
    input:
      nodeId: "${node.id}"
      key: "${event.key}"
      value: "${event.value}"

  - id: runStep
    kind: sequence
    steps:
      - id: maybeClearRecordingPath
        kind: conditional
        if: { op: neq, args: ["${event.step}", "upload"] }
        then:
          - kind: state.updateNodeParam
            input: { nodeId: "${node.id}", key: "recording_path", value: "" }

      - id: setStep
        kind: state.updateNodeParam
        input: { nodeId: "${node.id}", key: "step", value: "${event.step}" }

      - id: run
        kind: actions.runPluginNode
        input: { nodeId: "${node.id}" }

      - id: toast
        kind: ui.toast
        input:
          kind: info
          message: "Started '${event.step}'"

lifecycle:
  onMount:
    - kind: runQueries
      queries: [probe.uploaded, probe.sorted, probe.analyzed, probe.curation]
  onBindingChange:
    bindings: [computed.patient, computed.session]
    do:
      - kind: runQueries
        queries: [probe.uploaded, probe.sorted, probe.analyzed, probe.curation]

view:
  type: Stack
  props: { gap: md }
  children:
    - type: Panel
      props: { variant: moduleHeader }
      children:
        - type: Row
          props: { justify: spaceBetween, align: center }
          children:
            - type: Stack
              props: { gap: xs }
              children:
                - type: Text
                  props: { variant: title }
                  text: "${document.title}"
                - type: Text
                  props: { variant: subtitle }
                  text: "${document.subtitle}"
            - type: Badge
              props:
                kind:
                  op: if
                  args:
                    - { op: eq, args: ["${node.data.status}", running] }
                    - warn
                    - neutral
              text:
                op: if
                args:
                  - { op: eq, args: ["${node.data.status}", running] }
                  - "Running…"
                  - "Idle"

    - type: Panel
      props: { title: Inputs }
      children:
        - type: Grid
          props: { columns: 1, gap: sm }
          children:
            - type: TextField
              props:
                label: Patient
                placeholder: "e.g. Intan_RHD_2000"
                value: "${computed.patient}"
                onChange:
                  action: setParam
                  event: { key: patient, value: "${event.value}" }

            - type: TextField
              props:
                label: Session
                placeholder: "e.g. session_1"
                value: "${computed.session}"
                onChange:
                  action: setParam
                  event: { key: session, value: "${event.value}" }

            - type: PathField
              props:
                label: Recording path
                placeholder: "Absolute path to .rhd (or folder containing it)"
                value: "${computed.recordingPath}"
                onChange:
                  action: setParam
                  event: { key: recording_path, value: "${event.value}" }

    - type: Panel
      props: { title: Actions }
      children:
        - type: Toolbar
          props: { columns: 2, gap: sm }
          children:
            - type: Button
              props:
                label: Upload
                variant: primary
                disabled:
                  op: or
                  args:
                    - { op: not, args: ["${computed.canUpload}"] }
                    - { op: eq, args: ["${node.data.status}", running] }
                onClick:
                  action: runStep
                  event: { step: upload }

            - type: Button
              props:
                label: Sort
                variant: secondary
                disabled:
                  op: or
                  args:
                    - { op: not, args: ["${uiState.status.uploaded}"] }
                    - { op: eq, args: ["${node.data.status}", running] }
                onClick:
                  action: runStep
                  event: { step: sort }

            - type: Button
              props:
                label: Create Analyzer
                variant: secondary
                disabled:
                  op: or
                  args:
                    - { op: not, args: ["${uiState.status.sorted}"] }
                    - { op: eq, args: ["${node.data.status}", running] }
                onClick:
                  action: runStep
                  event: { step: analyze }

            - type: Button
              props:
                label: Launch Curation Window
                variant: secondary
                disabled:
                  op: or
                  args:
                    - { op: not, args: ["${uiState.status.analyzed}"] }
                    - { op: eq, args: ["${node.data.status}", running] }
                onClick:
                  action: runStep
                  event: { step: gui }

        - type: ProgressSteps
          props:
            steps:
              - { label: Upload, done: "${uiState.status.uploaded}" }
              - { label: Sort, done: "${uiState.status.sorted}" }
              - { label: Analyze, done: "${uiState.status.analyzed}" }
              - { label: Curation, done: "${uiState.status.curation}" }

        - type: InlineError
          props:
            visible: "${node.data.status == 'error'}"
            message: "${node.data.runtime.exec.last.error}"

    - type: Panel
      props: { title: Paths, collapsible: true, defaultOpen: false }
      children:
        - type: CodeBlock
          props:
            language: text
            value:
              op: concat
              args:
                - "raw: "
                - "${computed.rawSessionDir}"
                - "\nsorted: "
                - "${computed.sortedSessionDir}"
                - "\nsorter: "
                - "${computed.sorterDir}"
                - "\nanalyzer: "
                - "${computed.analyzerDir}"
