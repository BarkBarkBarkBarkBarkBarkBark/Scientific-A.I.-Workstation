declarative_ui_spec_version: "0.1"
kind: "PluginModule"
pluginId: "repo_intel_viewer"
title: "Repo Intel Viewer"
subtitle: "Scan repo imports and launch viewer"

actions:
  - id: launchViewer
    kind: sequence
    steps:
      - id: setLaunchTrue
        kind: state.updateNodeParam
        input: { nodeId: "${node.id}", key: "launch_viewer", value: true }
      - id: run
        kind: actions.runPluginNode
        input: { nodeId: "${node.id}" }
      - id: setLaunchFalse
        kind: state.updateNodeParam
        input: { nodeId: "${node.id}", key: "launch_viewer", value: false }

computed:
  url:
    op: trim
    args: ["${node.data.runtime.exec.last.outputs.status.metadata.url}"]
  hasUrl:
    op: gt
    args:
      - { op: len, args: ["${computed.url}"] }
      - 0
  nodeCount: "${node.data.runtime.exec.last.outputs.status.metadata.node_count}"
  edgeCount: "${node.data.runtime.exec.last.outputs.status.metadata.edge_count}"
  repoRoot:
    op: trim
    args: ["${node.data.runtime.exec.last.outputs.status.metadata.repo_root}"]
  hasCounts:
    op: gt
    args:
      - { op: len, args: ["${computed.nodeCount}"] }
      - 0

view:
  type: Stack
  props: { gap: md }
  children:
    - type: Panel
      props: { variant: moduleHeader }
      children:
        - type: Row
          props: { justify: spaceBetween, align: center }
          children:
            - type: Stack
              props: { gap: xs }
              children:
                - type: Text
                  props: { variant: title }
                  text: "${document.title}"
                - type: Text
                  props: { variant: subtitle }
                  text: "${document.subtitle}"
            - type: Badge
              props:
                kind:
                  op: if
                  args:
                    - { op: eq, args: ["${node.data.status}", running] }
                    - warn
                    - neutral
              text:
                op: if
                args:
                  - { op: eq, args: ["${node.data.status}", running] }
                  - "Running…"
                  - "Idle"

    - type: Panel
      props: { title: "Run / Launch" }
      children:
        - type: Row
          props: { justify: spaceBetween, align: center }
          children:
            - type: Text
              props: { variant: muted }
              text: "Run scans and reports counts. Launch Viewer opens the interactive graph in a new browser window."
            - type: Button
              props:
                label: "Launch Viewer"
                variant: primary
                disabled:
                  op: eq
                  args: ["${node.data.status}", running]
                onClick:
                  action: launchViewer
                  event: {}

        - type: Text
          props: { variant: muted }
          text:
            op: if
            args:
              - "${computed.hasCounts}"
              - { op: concat, args: ["Last scan: ", "${computed.nodeCount}", " files, ", "${computed.edgeCount}", " edges"] }
              - "Last scan: — (click Run)"

        - type: Text
          props: { variant: muted }
          text:
            op: if
            args:
              - { op: gt, args: [{ op: len, args: ["${computed.repoRoot}"] }, 0] }
              - { op: concat, args: ["Repo root: ", "${computed.repoRoot}"] }
              - "Repo root: —"

        - type: InlineError
          props:
            visible: "${node.data.status == 'error'}"
            message: "${node.data.runtime.exec.last.error}"

        - type: Text
          props: { variant: muted }
          text:
            op: if
            args:
              - "${computed.hasUrl}"
              - "Viewer URL"
              - "Viewer URL (launch to generate)"

        - type: CodeBlock
          props:
            language: "text"
            value:
              op: if
              args:
                - "${computed.hasUrl}"
                - "${computed.url}"
                - "—"
    - type: NodeRunPanel
